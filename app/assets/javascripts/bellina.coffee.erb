$.fn.extend {
  integrateSelect2: (selector)->
    selector = selector || '.select2'
    $(@).find(selector).select2({theme: "bootstrap",width: '100%'})
                
  integrateDatepicker: (selector)->
    selector = selector || '.datepicker'
    $(@).find(selector).datepicker({
      startView: 1,
      language: "es",
      orientation: "bottom auto",
      autoclose: true,
      todayHighlight: true,
      todayBtn: "linked",
      clearBtn: true


    })
}



set_events = ->
  
  $(':input').bind 'keyup mouseup', (e)->
    event_target = $(e.currentTarget);
    calc_value(event_target.parents('.field'))
    

  footwear_selects = $(".footwear_select")
  footwear_selects.on 'select2:select', (e) ->
    event_target = $(e.currentTarget);
    calc_value(event_target.parents('.field'))
    


calc_value = (parent) ->

  input_select = parent.find('.footwear_select') 
  id = input_select.val();
  input_value = parent.find('.footwear_value')
  input_value.empty()
  input_cant = parent.find('.footwear_cant')
  
  $.ajax
      type: 'POST'
      url: '/get_retail_price/'+id
      error: (jqXHR, textStatus, errorThrown) ->
        return
      success: (data) ->
        input_value.val(data.retail_price * input_cant.val())
        sum = 0
        $('.footwear_value').each ->
          sum += parseFloat(@value)

        if(isNaN(sum))
          sum = 0;
        $('#total').text(parseFloat(sum, 10).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1,").toString());
        return

  

$(document).ready ->
  $('.datatable').dataTable()


$(document).on 'turbolinks:load', ->
  datatable = $('.datatable')
  datatable.DataTable
    'language': 'url': '//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Spanish.json'
    'bPaginate': true
    'info': false
    'responsive': true
    'deferRender': true

    form = $('form')
    form.integrateSelect2()
    form.integrateDatepicker()


$(document).on 'turbolinks:before-cache', ->
    dataTable =  $($.fn.dataTable.tables(true)).DataTable()
    if (dataTable != null)
     dataTable.destroy();


$(document).on 'turbolinks:load', ->
  $('.footwears.new #footwear_release_country_id').val(11).trigger('change');

$(document).on 'cocoon:after-insert', (e) ->
  $('.select2').select2({theme: "bootstrap",width: '100%'})
  set_events()




